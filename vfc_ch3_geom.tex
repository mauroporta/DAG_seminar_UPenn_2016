\chapter{Geometricity of Mapping Stacks}
\label{ch3:geom}

This chapter is somewhat tangential to our concrete goals for the semester. However we thought that $\R\Map_{g,n}(X,\beta)$
provides a good opportunity to understand Artin-Lurie representability and how it can be used to prove that certain
mapping stacks are geometric.


\section{Using Artin-Lurie representability for Mapping Stacks}
The representability theorem says:

\begin{thm}[Artin-Lurie representability, Theorem 3.2.1 in \cite{DAG-XIV}]
\cite{thm:lurie_representability}
Let $X: \cdga_k^{\leq 0}\to \cS$ be a functor, and suppose we are given a natural transformation $f:X \to \Spec R$.
 Then $X$ is representable by a derived Deligne-Mumford $n$-stack locally almost of finite
presentation over $R$ if and only if the following are satisfied:
\begin{enumerate}
\item For every discrete commutative ring $A$, the space $X(A)$ is n-truncated.
\item $X$ is a sheaf for the \'etale topology.
\item $X$ is nilcomplete, infinitesimally cohesive and integrable. These mean:
\begin{itemize}
\item $X$ commutes with Postnikov towers;
\item $X$ commutes with pullback squares $B \times_A C$, under the assumption that $\pi_0(B) \to \pi_0(A)$ and $\pi_0(C) \to \pi_0(A)$
are surjective with nilpotent kernel;
\item for $A$ a complete local ring, $X(A) \simeq \varprojlim X(A/\fr m^n)$; loosely speaking, every formal $A$-point of $X$
integrates to give a point of $X$.
\end{itemize}
\item $f:X \to R$ admits a connective relative cotangent complex $\bbL_{X/R}$.
\item $f:X \to R$ is locally almost of finite presentation.
\end{enumerate}
\end{thm}

\begin{rem}
(2) is obvious, (5) ensures that the DM stack is locally almost of finite presentation. (3) and (4) ensure that $X$ has good
local behavior, in particular a good deformation theory. The existence of the relative cotangent complex is conceptually
the most important condition, and the one we will put the most effort into verifying. Finally, (1) encodes the geometricity
of the representing DM stack. $n$-stacks are defined to be those for which condition (1) holds; it is then true that: \todo{Mauro
said so; maybe also find a reference}
\begin{itemize}
\item $n$-geometric implies $n+1$-stack;
\item $m$-geometric for some $m$ and $n$-stack implies that, at worst, $m=n+1$.
\end{itemize}
\todo{this is not completely satisfactory: does Lurie representability guarantee that we get $m$-geometric for some $m$?}
\end{rem}

As an application of this, we want to prove the geometricity of mapping stacks.

\begin{thm}
\label{thm:mapping_stack_geometric}
Let $g: X \to Z$ be a morphism of derived stacks which is geometric and of finite type. Let $f:Y\to Z$ be a morphism of stacks
which is representable by proper flat schemes. \footnote{We could replace the condition on $f$ with something slightly more
general, such as representable by quasi-compact quasi-separated algebraic spaces of finite tor amplitude.} Then 
the mapping stack $\Map_{/Z}(Y,X)$ is geometric
over $Z$, i.e. the morphism $\Map_{/Z}(Y,X) \to Z$ is geometric.
\end{thm}
\begin{proof}
Recall that the mapping stack is defined by the functor of points:
\[	 \Map_{/Z}(Y,X) (T) = \Map_{\dSt}(T\times_Z Y, X). 	\]
We first reduce to $Z$ affine, so that Theorem \ref{thm:lurie_representability} applies.
Then, since $g$ is assumed geometric, it satisfies conditions (3) of the Theorem \ref{thm:lurie_representability}. 
It follows by elementary manipulation
of the diagrams that $\Map_{/Z}(Y,X) \to Z$ also has these properties; see Proposition 3.3.6 in \cite{DAG-XIV}.
The most important issue is the existence of a relative cotangent complex for $\Map_{/Z}(Y,X) \to Z$. 
Recalling the definition, we need to construct cotangent complexes $\bbL_{\Map_{/Z}(Y,X),x}$ at each point 
$x: \Spec A \to \Map_{/Z}(Y,X)$, and then make sure that they glue; this will be diagram \ref{} below.

$\bbL_{\Map_{/Z}(Y,X),x}$ is supposed to be an object that represents the functor of derivations over $\Map_{/Z}(Y,X)$:
\[	\Map_{A\Mod}(\bbL_{\Map_{/Z}(Y,X),x}, M) = \Der_{\Map_{/Z}(Y,X)}(A,M) .	\]
The latter is defined as the homotopy pullback:
\[
\begin{tikzcd}
\Der_{\Map_{/Z}(Y,X)}(A,M)\arrow{r}\arrow{d} & \Map(\Spec(A\oplus M) \times_Z Y, X)\arrow{d} \\
\Spec k\arrow{r} & \Map(\Spec A \times_Z Y, X).
\end{tikzcd}
\]
Let $q: \Spec A \times_Z Y \to \Spec A$ denote the projection. Then $\Spec(A\oplus M) \times_Z Y$ coincides with the extension
$(\Spec A \times_Z Y)[q^*M]$ by the pullback $q^*M$.\footnote{Work locally, take 
$\Spec(A \otimes_{\mathcal{O}_Z} \mathcal{O}(Y) \oplus M\otimes_{\mathcal{O}_Z} \mathcal{O}(Y)$ over each affine piece and glue.}
Therefore the pullback diagram becomes:
\[
\begin{tikzcd}
\Der_{X}(A,q^*M)\arrow{r}\arrow{d} & \Map((\Spec A \times_Z Y) [q^*M], X)\arrow{d} \\
\Spec k\arrow{r} & \Map(\Spec A \times_Z Y, X).
\end{tikzcd}
\]
Now the top left is equivalent to $\Map_{\Spec A \times_Z Y}(f_x^*\bbL_{X/Z}, q^*M)$. So the existence of a cotangent complex at the
point $x$ is reduced to:
\[	\Map_{A\Mod}(\bbL_{\Map_{/Z}(Y,X),x}, M) \simeq \Map_{\Spec A \times_Z Y}(f_x^*\bbL_{X/Z}, q^*M).	\]
Thus, we need a left adjoint for $q^*$; this is the map $q_+$ introduced in \ref{} below. Then we can define:
\begin{equation}
\label{eq:mapping_local_cotangent}
	\bbL_{\Map_{/Z}(Y,X)/Z,x} := q_+ f_x^*\bbL_{X/Z}.
\end{equation}

Finally, we address the gluing of these cotangent complexes. Assume that we have a morphism $g: \Spec B \to \Spec A$. We define
a point $y: \Spec B \to \Map_{/Z}(Y,X)$ by requiring the following diagram to commute:
\[
\begin{tikzcd}
\; & & X \\
Y \times_Z \Spec B \arrow{r} \arrow{d}{q_B} \arrow{urr}{f_y} & Y\times_Z \Spec A \arrow{d}{q_A}\arrow[swap]{ur}{f_x} & \\
\Spec B\arrow{r}{g} & \Spec A &
\end{tikzcd}
\]
From the commutativity of the upper triangle we obtain $f_y = f_x \circ 1\times g$, so that:
\[	q_{B+} f_y^* \bbL_X \simeq q_{B+}(1\times g)^*f_x^*\bbL_X .	\]
Our goal is to show that gluing works, which means:
\[	q_{B+} f_y^* \bbL_X \simeq g^* q_{A*} f_x^* \bbL_X.	\]
Therefore it suffices to prove that $q_+$ has the base change property $q_{B+}(1\times g)^* \simeq g^* q_{A+}$. This
is the object of Lemma \ref{lem:q+_base}, while the construction of $q_+$ is Lemma \ref{lem:q+}.
\end{proof}

\begin{rem}
\label{rem:mapping_global_cotangent}
The tangent complex of the mapping stack, when it exists, can be obtained more easily from the diagram:
\[
\begin{tikzcd}
\Map_{/Z}(Y,X) \times_Z Y \arrow{d}{\pi}\arrow{dr}{ev} & \\ \Map_{/Z}(Y,X) & X.
\end{tikzcd}
\]
Then:
\[	\bbT_{\Map_{/Z}(Y,X)/Z} = \pi_* \ev^* \bbT_{X/Z}.	\]
We would like to dualize and obtain:
\begin{equation}
\label{eq:mapping_global_cotangent}
	\bbL_{\Map_{/Z}(Y,X)/Z} = (\pi_* \ev^* \bbL_{X/Z}^{\vee})^{\vee} = \pi_+ \ev^* \bbL_{X/Z}.
\end{equation}
In Theorem \ref{thm:mapping_stack_geometric}, we actually prove that $\bbL_{\Map_{/Z}(Y,X)/Z}$ exists, by constructing
it locally and then showing that the construction glues. The result of the gluing must then be \ref{eq:mapping_global_cotangent},
as can be seen from the extended diagram:
\[
\begin{tikzcd}
\Spec A \times_Z Y\arrow{r}{x\times 1}\arrow{d}{q} &\Map_{/Z}(Y,X) \times_Z Y \arrow{d}{\pi}\arrow{dr}{ev} & \\
\Spec A\arrow{r}{x} & \Map_{/Z}(Y,X) & X.
\end{tikzcd}
\]
Since the square is a homotopy pullback, we apply base change for $q_+$ (see Lemma \ref{lem:q+_base}):
\[	x^* \pi_+ \ev^* \bbL_{X/Z} \simeq q_+ (x\times 1)^* \ev^* \bbL_{X/Z} \simeq q_+ f_x^*\bbL_{X/Z},	\]
which agrees with what we called $\bbL_{\Map_{/Z}(Y,X)/Z,x}$ in \ref{eq:mapping_local_cotangent}. It follows that
$\bbL_{\Map_{/Z}(Y,X)/Z} \simeq \pi_+ \ev^* \bbL_{X/Z}$.
\end{rem}


\section{Stable Maps}
We apply Theorem \ref{thm:mapping_stack_geometric} and Remark \ref{rem:mapping_global_cotangent} to the derived 
moduli space of stable maps on a smooth projective
variety $X$:
\[	\R\mathcal{M}_{g,k}(X) = \Map_{dSt/\mathcal{M}_{g,k}}(\mathcal{C}_{g,k},X\times \mathcal{M}_{g,k}).	\]
According to Remark \ref{rem:mapping_global_cotangent}, and using the notation therein:
\begin{equation}
\label{eq:cotangent_stable_prelim}
	\bbL_{\R\mathcal{M}_{g,k}(X)/\mathcal{M}_{g,k}} = \pi_+ \ev^* \bbL_{X\times \mathcal{M}_{g,k}/\mathcal{M}_{g,k}}.
\end{equation}
We can simplify this expression using the pullback diagram:
\[
\begin{tikzcd}
X \times \mathcal{M}_{g,k}\arrow{r}{p}\arrow{d} & X\arrow{d} \\ \mathcal{M}_{g,k}\arrow{r} & \Spec k .
\end{tikzcd}
\]
The diagram implies $\bbL_{X\times \mathcal{M}_{g,k}/\mathcal{M}_{g,k}} \simeq p^* \bbL_X$, so \ref{eq:cotangent_stable_prelim}
reduces to:
\begin{equation}
\label{eq:cotangent_stable}
	\bbL_{\R\mathcal{M}_{g,k}(X)/\mathcal{M}_{g,k}} = \pi_+ \ev^* p^* \bbL_{X}.
\end{equation}

\begin{prop}
The natural map $\R \mathcal{M}_{g,k}(X) \to \mathcal{M}_{g,k}$ is quasi-smooth.
\end{prop}
\begin{proof}
We need to show that $\bbL_{\R\mathcal{M}_{g,k}(X)/\mathcal{M}_{g,k}} = \pi_+ \ev^* p^* \bbL_{X}$ has cohomological amplitude
$[-1,0]$. $X$ is a smooth variety, so $\bbL_X$ is in amplitude $[0,0]$. Pullbacks preserve cohomological amplitude, because
they only involve tensoring with locally free sheaves. \todo{Need any assumption on the maps?} $\pi_*$ may increase cohomological
amplitude, because of higher direct image sheaves. However, that the fibers of $\pi : \R\mathcal{M}_{g,k}(X) 
\times_{\mathcal{M}_{g,k}} \mathcal{C}_{g,k} \to \mathcal{M}_{g,k}$ are curves, so the cohomological amplitude of
$\pi_* (\ev^* p^* \bbL_{X})^{\vee}$ is at most $[0,1]$. Dualizing again brings $\bbL_{\R\mathcal{M}_{g,k}(X)/\mathcal{M}_{g,k}}$
to amplitude $[-1,0]$.
\end{proof}

Together with the fact that $\mathcal{M}_{g,k}$ is smooth, this implies that $\R\mathcal{M}_{g,k}(X)$ is quasi-smooth.
Proposition \ref{prop:derived_obstruction_theory} implies the following.

\begin{cor}
The derived enhancement $j: \mathcal{M}_{g,k}(X) \to \R\mathcal{M}_{g,k}(X)$ determines a perfect obstruction theory
on $\mathcal{M}_{g,k}(X)$:
\[	j^* \bbL_{\R\mathcal{M}_{g,k}(X)} \to \bbL_{\mathcal{M}_{g,k}(X)}.	\]
\end{cor}

Expression \ref{eq:cotangent_stable} for the cotangent complex of $\R\mathcal{M}_{g,k}(X)$ shows that the obstruction theory
is the same as that considered by \cite{Behrend_Intrinsic_normal_cone_1997} and introduced in 
\todo{reference once the chapter is edited}.




\section{The + Pushforward Functor}

\begin{lem}[3.3.22 and 3.3.23 in \cite{DAG-XII}]
\label{lem:q+}
Suppose that $q: Y \to S$ is perfect, i.e. $q_*$ preserves perfect complexes. Then $q^* : \QCoh(S) \to \QCoh(Y)$ has a left
adjoint $q_+$.
\end{lem}
\begin{proof}
Let $F \in \Perf(Y)$ and $G \in \QCoh(S)$. Then:
\begin{align*}
	&\Map_{\QCoh(S)} \big( (q_*F^{\vee})^{\vee}, G\big) \simeq \Map_{\QCoh(S)} \big( \mathcal{O}_S, q_*F^{\vee} \otimes G\big) \\
\simeq& \Map_{\QCoh(S)} \big(\mathcal{O}_S, q_*(F^{\vee} \otimes q^* G)  \big) \simeq \Map_{\QCoh(Y)}(\mathcal{O}_Y,F^{\vee} \otimes q^*G)
 \simeq \Map_{\QCoh(Y)}(F,q^*G).
\end{align*}
We have used the fact that perfect complexes are dualizable and the projection formula $q_*(F^{\vee} \otimes q^* G)
\simeq q_*F^{\vee} \otimes G$. This means that, for $F$ perfect, we can use $q_+F = (q_*F^{\vee})^{\vee}$. Now if $S$ and $q$
are quasi-compact and quasi-separated, $\QCoh(Y) = \Ind \Perf(Y)$. Remarking that $q_+ : \Perf(Y) \to \QCoh(S)$ is a left
adjoint, it commutes with colimits, and so there exists a unique extension $q_+ : \Ind \Perf(Y) \to \QCoh(S)$ which commutes with
colimits. It also follows that the extension is a left adjoint.
\end{proof}

\begin{lem}[3.3.23 in \cite{DAG-XII}]
\label{lem:q+_base}
Suppose given a pullback diagram of DM stacks, \todo{can we do better?} with $f, f'$ perfect.
\[
\begin{tikzcd}
X'\arrow{r}{g'}\arrow{d}{f'} & X\arrow{d}{f} \\ Y' \arrow{r}{g} & Y
\end{tikzcd}
\]
Then the canonical map $\lambda: f'_+ \circ g'^* \to g^* f_+$ is an equivalence. 
(We say that the + pushforward satisfies base change.)
\end{lem}
\begin{proof}
On perfect objects $F$, $\lambda_F$ is the dual of:
\[	g^*f_* F \to f'_*g'^* F.	\]
We have used the fact that pullbacks preserve duals. This is an isomorphism due to base change for the pusforward $f_*$.
To conclude, both $f_+$ and $g^*$ are now left adjoints, which means they preserve all colimits. It follows that
$f'_+ \circ g'^* \simeq g^* f_+$ extends to $\QCoh \simeq \Ind \Perf$.
\end{proof}

Note that we have used the assumption that $q: Y \to S$ is perfect. It remains, then, to prove that the map $q : \Spec A \times_Z Y
\to \Spec A$ from the proof of Theorem \ref{thm:mapping_stack_geometric} is perfect. We do this in Lemma \ref{lem:q_perfect}
below, after introducing some terminology.

\begin{defin}
A map $q:Y \to S$ is \textbf{categorically proper}, also called \textbf{of finite cohomological dimension}, if
$q_* : \QCoh(Y) \to \QCoh(S)$ increases cohomological dimension by a uniform finite amount.
\end{defin}

\begin{defin}
A map $q:Y \to S$ is \textbf{of finite tor amplitude} if locally $q:\Spec B \to \Spec A$ and $B$ is of finite tor amplitude
as an object of $A\Mod$.
\end{defin}

Note that in our example $q: \Spec A \times_Z Y \to \Spec A$, $q$ is:
\begin{itemize}
\item proper, because we assumed that $Y \to Z$ is proper, and this is stable under base change;
\item categorically proper, because we can compute $q_*$ by a (uniformly) finite \v{C}ech resolution, due to the assumption
that $Y \to Z$ is representable by proper schemes.
\item of finite tor amplitude, because this is a consequence of flatness. We have assumed that $Y\to Z$ is flat,
and flatness is stable under base change.
\end{itemize}

\begin{lem}
\label{lem:q_perfect}
Let $q: Y \to S$ be a map which is proper, categorically proper and of finite tor amplitude. Then $q$ is perfect.
\end{lem}
\begin{proof}
First, we claim that the first two assumptions imply that $q_* \Coh^-(X) \to \Coh^-(S)$. This argument uses the Leray spectral
sequence. \todo{fill this in} Next, note that $\Perf(X) \subset \Coh^-(X)$ is characterized as the full subcategory of complexes
with finite tor amplitude. So it remains to prove that, if $F \in \Coh^-(X)$ has finite tor amplitude, then so does $q_*F$.

Take a Zariski affine cover for $X$; due to the quasi-compactness assumption this can be taken finite. Then the \v{C}ech nerve
$U^{\bullet}$ is a finite complex. Since $q_*$ is a right adjoint, it commutes with limits, and we have:
\[	q_* F = \varprojlim q|_{U^{\bullet}*} F|_{U^{\bullet}}.	\]
Note that the maps $U_i \to X$ are not, in general, proper, so $q|_{U^{\bullet}*} F|_{U^{\bullet}}$ needn't be coherent. However,
on affines $q_*$ is just a forgetful functor on modules. Therefore the coherence of $q|_{U^{\bullet}*} F|_{U^{\bullet}}$
follows from the fact that $F|_{U^{\bullet}}$ is coherent and the map on rings is finitely generated. \todo{explain more}

For finite tor amplitude, it suffices to check that, for every $M$ discrete, $q_*F \otimes_{\mathcal{O}_S} M$ is cohomologically
supported in $[-m,\infty)$ for some $m$. (We already know that $q_*F$ is bounded above.) Since the \v{C}ech nerve is finite,
we have:
\[	q_*F \otimes_{\mathcal{O}_S} M = \varprojlim q|_{U^{\bullet}*} F|_{U^{\bullet}} \otimes_{\mathcal{O}_S} M.	\]
The inclusion $\Coh^{-,[-m,\infty)}(S) \subset \Coh^-(S)$ commutes with limits, which gives the result.
\end{proof}




\section{Application: Weil Restriction}
Weil restriction is, roughly speaking, an adjoint for base change. We sketch the treatment that Lurie gives in \cite{DAG-XIV}.

\begin{defin}
Let $\phi : Y \to Z$ and $X \to Y$ be maps of derived stacks. A \textbf{Weil restriction} for $X$ along $\phi$ is a
stack $\Res_{Y/Z}X \to Z$, equipped with a morphism $\rho_X : \Res_{Y/Z}X \times_Z Y \to X$ over $Y$, such that composition
with $\rho$ determines a homotopy equivalence:
\begin{equation}
\label{eq:weil_restriction}
	\Map_{\dSt/Z}( - , \Res_{Y/Z}X) \simeq \Map_{\dSt/Y}(- \times_Z Y, X).
\end{equation}
\end{defin}

\begin{eg}
In arithmetic geometry $\phi: Y \to Z$ is taken to be a field extension $\phi : \Spec L \to \Spec k$; then the adjunction
\ref{eq:weil_restriction} gives a bijection between $L$-points of $X$ and $k$-points of $\Res_{\Spec L/\Spec k}X$. To illustrate
this without getting too much out of our comfort zone, we take $k = \R$, $L = \C$, and start with $X$ an affine variety over $\C$,
given as a subset of $\C^n$ by equations $f_i(z_1, \dots, z_n) = 0$. Then $\Res{\Spec L/\Spec k}X$ is an affine variety over $\R$,
given as a subset of $\R^{2n}$ by equations $\Re f_i(x_1 + i y_1, \dots, x_n + i y_n) = 0$, 
$\Im f_i(x_1 + i y_1, \dots, x_n + i y_n) = 0$.
\end{eg}

Lurie proves the following existence result.

\begin{thm}

\end{thm}
\begin{proof}
The basic idea is to define $\Res_{Y/Z}X$ as the homotopy pullback:
\[
\begin{tikzcd}
\Res_{Y/Z}X\arrow{r}\arrow{d} & \Map_{/Z}(Y,X)\arrow{d} \\
Z\arrow{r} & \Map_{/Z}(Y,Y)
\end{tikzcd}
\]
\end{proof}


